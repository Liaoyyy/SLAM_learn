# 视觉里程计

## 特征点法
*特征点表示图像特征，一般取角点、边缘和区块*

特征点由**关键点**和**描述子**两部分组成
- 关键点：特征点在图像中的位置
- 描述子：通常一个向量，描述关键点周围像素信息

### ORB特征
**ORB特征由FAST关键点与BRIEF描述子组成**

### 特征匹配
*目标：将不同角度看到的同一路标相匹配*

一种最简单思路：暴力匹配
描述子距离表征两个特征之间的相似程度--汉明距离（求两个向量不同位数的个数）
其他方法：快速近似最近邻算法(FLANN)

### 相机位姿估计
*如何由两张特征匹配后的图片得到相机位姿变化的齐次矩阵T？*

#### 2D-2D 对极几何约束
**关键：利用匹配点源于同一个点，即两张照片的相机中心到匹配点的射线必定相交于目标点**

设目标点为$P$，相机中心点为$O_1,O_2$，设目标点$P$的空间位置为$[X,Y,Z]$(照片1的相机坐标系下坐标)，K为相机内参

两个像素点$p_1,p_2$满足单目相机的像素坐标系与相机坐标系坐标转换公式
$$
s_1 p_1=KP,s_2 p_2 = KP_2 = K(R_{21}P+t_{21})
$$
其中，$s_1,s_2$为两坐标系下目标点深度信息（$z$大小）

对单目相机而言，无法获取目标深度信息，故可认为$s$为一个比例系数，只利用其正比关系
$$
p_1 \simeq KP,p_2 \simeq K(RP+t)
$$
取$x_1=K^{-1}p_1,x_2=K^{-1}p_2$，则利用上式得到
$$
\begin{align} 
&x_2 \simeq Rx_1+t \nonumber \\
&\hat{t}x_2 \simeq \hat{t}Rx_1 \nonumber \\
&x_2^T \hat{t}x_2 \simeq x_2^T \hat{t}Rx_1 \nonumber
\end{align}
$$
又$\hat{t}x_2$表示$t$与$x_2$做外积，该平面垂直于$x_2^T$，故可以进而得到
$$
x_2^T\hat{t}R x_1=0
$$
或者
$$
p_2^t (K^{-1})^T \hat{t}RK^{-1}p_1=0
$$
定义$E=\hat{t}R$，$F=K^{-T}\hat{t}RK^{-1}$

**求解相机位姿的一般方法:**
- 根据配对的像素点求出$E$或$F$矩阵
- 根据$E$或$F$求解出$R,t$


1. 本质矩阵$E$:
   由于2D图片丢失目标深度信息，$E$只有五个自由度(3平移+3旋转-1)
   考虑一对匹配点$x_1=[u_1,v_1,1]^T,x_2=[u_2,v_2,1]^T$，将矩阵E(3x3矩阵)写成向量形式$[e_1,e_2,e_3,e_4,e_5,e_6,e_7,e_8,e_9]$
   则$x_2^TEx_1=0$可改写为
   $$
   [u_2u_1,u_2v_1,u_2,u_1v_2,v_1v_2,v_2,u_1,v_1,1]\cdot e=0
   $$
   当存在8对这样的匹配点时，由于矩阵秩为8，零空间维数为1，e构成一条直线（与自由度分析一致）
   得到$E$后可通过SVD分解得到$R,t$

   **当匹配点对数＞8时，方程构成超定方程，可能不存在有效解e，可通过最小化一个二次型**
   $$
   min_{e} ||Ae||_2^2=min_e e^TA^TAe
   $$
2. 单应矩阵$H$:
   设一对匹配的特征点$p_1,p_2$
   特征点$p_1$位于对应像素平面上，满足空间中平面方程
   $$
   n^TP+d=0 \\
   -\frac{n^TP}{d}=1
   $$
   又从以上推导中得到:
   $$
   \begin{align} 
   p_2 &\simeq K(RP+t) \nonumber \\
       &\simeq K(RP+t\cdot (-\frac{n^TP}{d})) \nonumber \\
       &\simeq K(R-\frac{tn^T}{d})P \nonumber \\
       &\simeq K(R-\frac{tn^T}{d})K^{-1}p_1 \nonumber \\
   \end{align}
   $$
   定义单应矩阵$H=K(R-\frac{tn^T}{d})K^{-1}$
   该自由度为8的单应矩阵可由4对匹配特征点算出（这四点不能出现三点共线情况）

**由于单目SLAM无深度信息，对地图进行放缩相同倍数无影响，故存在初始化问题，即取第一次相机移动的平移距离为基准（取$t$为1），以后平移距离均以第一次平移量为单位**

#### 三角测量
*对单目相机而言，确实深度信息导致无法获取目标点的距离数据*

假设一对匹配点的归一化坐标$x_1,x_2$已知，且从位置1到位置2的变换矩阵$T$可以获得，那么可以由坐标变换得到
$$
s_2 x_2 =s_1 R x_1+t
$$
其中$s_2 x_2$表示目标点在位置1的相机坐标系下坐标，$s_1 x_1$表示目标点在位置2的相机坐标系下坐标，上式即为坐标变换公式

再对上式左乘$\hat{x^2}$得到
$$
s_2 \hat{x_2} x_2=0=s_1 \hat{x_2} R x_1+\hat{x_2}t
$$
利用上式可求得$s_1$，进而求$s_2$

#### 3D-2D: PnP
**已知空间中一组3D点的位置以及它们在某个相机中的投影位置**

1. **直接线性变换(DLT)**
   考虑空间中一个点，在世界坐标系下其齐次坐标为$P=(X,Y,Z,1)^T$，在图像$I_1$中，投影的特征点为(归一化坐标)$x_1=(u_1,v_1,1)^T$，利用坐标变换(中间为增广矩阵$[R|t]$)可以得到
   $$
   s
   \begin{bmatrix}
   u_1 \\ v_1 \\ 1
   \end{bmatrix} =
   \begin{bmatrix} 
   t_1 & t_2 & t_3 & t_4 \\
   t_5 & t_6 & t_7 & t_8 \\
   t_9 & t_{10} & t_{11} & t_{12} \\
   \end{bmatrix}
   \begin{bmatrix}
   X \\ Y \\ Z \\ 1
   \end{bmatrix} 
   $$
   (ps：这里维度不匹配，对等号右边仅取前三行)
   令增广矩阵三行分别为向量$\bold{t_1},\bold{t_2},\bold{t_3}$，消去深度信息$s$得到
   $$
   \bold{t_1}^T \bold{P}-\bold{t_3}\bold{P}u_1=0 \\
   \bold{t_2}^T \bold{P}-\bold{t_3}\bold{P}v_1=0
   $$
   由于增广矩阵存在12个变量，一个特征点可给出两个独立方程，故有6组特征点时可解出位姿变换$R,t$。特别地，大于6组时方程超定，考虑最小二乘解
2. P3P
   方法一：P3P仅使用3对匹配点
   ![](./image/ch7/2024-03-13%2015-48-48%20的屏幕截图.png)
   基本流程:
      由三对匹配点的空间坐标(世界坐标系下坐标)和对应像素坐标求解三对点在相机坐标系下坐标(利用几何关系，求解二元二次非线性方程组)，转为求解3D-3D问题，进而求得相机运动R,t

   方法二：最小化重投影误差求解PnP
   即求解最优化问题（$u_i,P_i$为第$i$个点的像素坐标与世界坐标系下坐标）:
   $$
   T^{\star}=\argmin_{T} \frac{1}{2} \sum_{i=1}^n ||u_i-\frac{1}{s_i}KTP_i||_2^2
   $$

   **实际应用中：**
      在实际应用中，通常先选取三对匹配点求解PnP问题（求解二元二次非线性方程组转化为3D-3D的ICP问题，进而求解得到R，t），将结果R,t作为初值，再利用最小化重投影误差(BA)求解非线性问题，对R,t进行优化得到最终结果。
   

#### 3D-3D：ICP(Iterative Closest Point)
   3D-3D匹配无需相机模型，激光SLAM也会遇到ICP问题
   1. SVD方法
      对第i对匹配点，定义误差项
      $$
      e_i=p_i-(Rp_i'+t)
      $$
      构建最小二乘问题
      $$
      \min_{R,t} \frac{1}{2} \sum_{i=1}^n ||p_i-(Rp_i'+t)||_2^2
      $$
      设两组点质心为$p,p'$
      上述优化问题可化简为
      $$
      \min_{R,t} J = \frac{1}{2} \sum_{i=1}^n ||p_i-p-R(p_i'-p')||^2+||p-Rp'-t||^2
      $$
      求解时由于R,t独立，可先最小化求解第一项得到旋转矩阵R，进而令第二项为0求解得到t

      步骤:
      1. 求解两组点质心位置${p},{p'}$，然后计算每个点去质心坐标：$q_i=p_i-p,q_i'=p_i'-p$
      2. 根据以下优化问题求解旋转矩阵
         $$
         \begin{align}
         R^{*} &=\argmin_R \frac{1}{2} \sum_{i=1}^n ||q_i-Rq_i'||^2 \nonumber \\
          &= \argmin_R \frac{1}{2} \sum_{i=1}^n(q_i^Tq_i+q_i'^{T}R^TRq_i'-2q_i^T R q_i')  \nonumber \\
          &= \argmin_R \frac{1}{2} \sum_{i=1}^n(q_i^Tq_i+q_i'^{T}q_i'-2q_i^T R q_i')\nonumber
         \end{align}
         $$
         故只需要最小化
         $$
         \begin{align}
         &\argmin_R \sum_{i=1}^n(-q_i^T R q_i') \nonumber \\
         &= \argmin_R \nonumber (-tr(R\sum_{i=1}^nq_i' q_i^T))
         \end{align}
         $$
      3. 根据上述推到求解t
         $$
         t^*=p-Rp'
         $$
   2. 非线性优化方法
      使用李群求导方法
      $$
      \min_{\xi} = \frac{1}{2} \sum_{i=1}^n ||(p_i-exp(\hat{\xi})p_i')||_2^2
      $$


## 直接法
*特征点法存在一些问题：特征点提取慢(SIFT),忽略了特征点以外所有信息，相机有时会运动到特征缺失的地方*
**直接法不再计算关键点，而考虑像素的亮度信息估计相机的运动，此外直接法还可以重构稀疏，半稠密，稠密地图，而特征点法只能构建稀疏地图**

### 2D光流
稀疏光流：仅追踪部分像素的运动轨迹。（典型：Lucas-Kanade光流，LK光流）

#### LK 光流
- 基本假设(灰度不变假设)：同一空间点的像素灰度值在各个图片中固定不变（这是一个很强的假设，实际可能不成立）

设$t$时刻$(x,y)$点的灰度为$I(x,y,t)$
在$t+\Delta t$时刻运动到$(x+\Delta x,y+\Delta y)$处，灰度不变，即$I(x+\Delta x,y+\Delta y,t+\Delta t)=I(x,y,t)$
利用泰勒展开得到
$$
I(x+\Delta x,y+\Delta y,t+\Delta t) = I(x,y,t) + \frac{\partial I}{\partial x} dx+ \frac{\partial I}{\partial y} dy+ \frac{\partial I}{\partial t} dt
$$
进而可得到
$$
\frac{\partial I}{\partial x} \frac{dx}{dt}+ \frac{\partial I}{\partial y} \frac{dy}{dt} = - \frac{\partial I}{\partial t}
$$
设$x,y$方向速度为$[u,v]$
$$
\begin{bmatrix}
I_x & I_y
\end{bmatrix}
\begin{bmatrix}
u \\ v
\end{bmatrix}
= -I_t
$$
**对于一个小窗口$w \times w$内像素点可认为具有相同的运动，即可得到$w^2$个方程，再利用最小二乘法得到结果**
$$
A=
\begin{bmatrix}
[I_x & I_y]_1 \\
... & ...\\
[I_x & I_y]_k \\
\end{bmatrix} \\
$$

$$
\begin{bmatrix}
u \\ v
\end{bmatrix} = -(A^TA)^{-1} A^T b
$$

- 如何两张图片对应匹配点?
  最小化灰度误差进而估计最右的像素偏移
  - 单层光流
  - 多层光流

### 直接法
**直接法类似于特征点匹配的方法，但最小化光度误差**
考虑两张照片像素坐标与空间坐标关系
$$
p_1 = \begin{bmatrix} 
u \\ v \\ 1
\end{bmatrix}_1
= \frac{1}{Z_1} KP
$$
$$
p_2 = \begin{bmatrix} 
u \\ v \\ 1
\end{bmatrix}_2
= \frac{1}{Z_2} K(RP+t) = \frac{1}{Z_2} K(TP)_{1:3}
$$
光度误差定义为
$$
e=I_1(p_1)-I_2(p_2)
$$
优化目标为
$$
\min_{T} J(T)=||e||^2=\sum_{i=1}^N e_i^Te_i
$$
**如果将所有像素点均纳入优化函数，即可重建稠密地图**

### 直接法优缺点
- 优点
  1. 省去计算特征点，描述子时间
  2. 只要求有像素梯度，不需要特征点，即可在特征缺失的场合下使用
  3. 可以构建半稠密/稠密地图
- 缺点
  1. 非凸性 （完全依赖梯度搜索，降低损失来计算相机位姿，容易陷入局部最优，多层光流可以缓解这个问题）
  2. 单个像素没有区分度 （像素点少时效果差）
  3. 灰度不变时很强的假设 （实际中灰度可能变化-相机曝光自动调整/光照变化）

## 课后题的一些讨论
### 其他提取特征点方法：
[其他特征点方法](https://zhuanlan.zhihu.com/p/375451354)

### 如何抑制误匹配
如对ICP问题，一个很好的方法是加入鲁棒核函数（避免误匹配误差过大，导致优化时优先考虑优化误匹配项，得到错误的位姿估计）
*RANSAC(Random Sample Consensus)随机抽样一致算法*

### PNP求解算法
[EPNP解法](https://zhuanlan.zhihu.com/p/59070440)