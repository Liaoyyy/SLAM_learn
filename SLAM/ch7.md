# 视觉里程计1

## 特征点法
*特征点表示图像特征，一般取角点、边缘和区块*

特征点由**关键点**和**描述子**两部分组成
- 关键点：特征点在图像中的位置
- 描述子：通常一个向量，描述关键点周围像素信息

### ORB特征
**ORB特征由FAST关键点与BRIEF描述子组成**

### 特征匹配
*目标：将不同角度看到的同一路标相匹配*

一种最简单思路：暴力匹配
描述子距离表征两个特征之间的相似程度--汉明距离（求两个向量不同位数的个数）
其他方法：快速近似最近邻算法(FLANN)

### 相机位姿估计
*如何由两张特征匹配后的图片得到相机位姿变化的齐次矩阵T？*

#### 2D-2D 对极几何约束
**关键：利用匹配点源于同一个点，即两张照片的相机中心到匹配点的射线必定相交于目标点**

设目标点为$P$，相机中心点为$O_1,O_2$，设目标点$P$的空间位置为$[X,Y,Z]$(照片1的相机坐标系下坐标)，K为相机内参

两个像素点$p_1,p_2$满足单目相机的像素坐标系与相机坐标系坐标转换公式
$$
s_1 p_1=KP,s_2 p_2 = KP_2 = K(R_{21}P+t_{21})
$$
其中，$s_1,s_2$为两坐标系下目标点深度信息（$z$大小）

对单目相机而言，无法获取目标深度信息，故可认为$s$为一个比例系数，只利用其正比关系
$$
p_1 \simeq KP,p_2 \simeq K(RP+t)
$$
取$x_1=K^{-1}p_1,x_2=K^{-1}p_2$，则利用上式得到
$$
\begin{align} 
&x_2 \simeq Rx_1+t \nonumber \\
&\hat{t}x_2 \simeq \hat{t}Rx_1 \nonumber \\
&x_2^T \hat{t}x_2 \simeq x_2^T \hat{t}Rx_1 \nonumber
\end{align}
$$
又$\hat{t}x_2$表示$t$与$x_2$做外积，该平面垂直于$x_2^T$，故可以进而得到
$$
x_2^T\hat{t}R x_1=0
$$
或者
$$
p_2^t (K^{-1})^T \hat{t}RK^{-1}p_1=0
$$
定义$E=\hat{t}R$，$F=K^{-T}\hat{t}RK^{-1}$

**求解相机位姿的一般方法:**
- 根据配对的像素点求出$E$或$F$矩阵
- 根据$E$或$F$求解出$R,t$


1. 本质矩阵$E$:
   由于2D图片丢失目标深度信息，$E$只有五个自由度(3平移+3旋转-1)
   考虑一对匹配点$x_1=[u_1,v_1,1]^T,x_2=[u_2,v_2,1]^T$，将矩阵E(3x3矩阵)写成向量形式$[e_1,e_2,e_3,e_4,e_5,e_6,e_7,e_8,e_9]$
   则$x_2^TEx_1=0$可改写为
   $$
   [u_2u_1,u_2v_1,u_2,u_1v_2,v_1v_2,v_2,u_1,v_1,1]\cdot e=0
   $$
   当存在8对这样的匹配点时，由于矩阵秩为8，零空间维数为1，e构成一条直线（与自由度分析一致）
   得到$E$后可通过SVD分解得到$R,t$

   **当匹配点对数＞8时，方程构成超定方程，可能不存在有效解e，可通过最小化一个二次型**
   $$
   min_{e} ||Ae||_2^2=min_e e^TA^TAe
   $$
2. 单应矩阵$H$:
   设一对匹配的特征点$p_1,p_2$
   特征点$p_1$位于对应像素平面上，满足空间中平面方程
   $$
   n^TP+d=0 \\
   -\frac{n^TP}{d}=1
   $$
   又从以上推导中得到:
   $$
   \begin{align} 
   p_2 &\simeq K(RP+t) \nonumber \\
       &\simeq K(RP+t\cdot (-\frac{n^TP}{d})) \nonumber \\
       &\simeq K(R-\frac{tn^T}{d})P \nonumber \\
       &\simeq K(R-\frac{tn^T}{d})K^{-1}p_1 \nonumber \\
   \end{align}
   $$
   定义单应矩阵$H=K(R-\frac{tn^T}{d})K^{-1}$
   该自由度为8的单应矩阵可由4对匹配特征点算出（这四点不能出现三点共线情况）

**由于单目SLAM无深度信息，对地图进行放缩相同倍数无影响，故存在初始化问题，即取第一次相机移动的平移距离为基准（取$t$为1），以后平移距离均以第一次平移量为单位**

#### 三角测量
*对单目相机而言，确实深度信息导致无法获取目标点的距离数据*

假设一对匹配点的归一化坐标$x_1,x_2$已知，且从位置1到位置2的变换矩阵$T$可以获得，那么可以由坐标变换得到
$$
s_2 x_2 =s_1 R x_1+t
$$
其中$s_2 x_2$表示目标点在位置1的相机坐标系下坐标，$s_1 x_1$表示目标点在位置2的相机坐标系下坐标，上式即为坐标变换公式

再对上式左乘$\hat{x^2}$得到
$$
s_2 \hat{x_2} x_2=0=s_1 \hat{x_2} R x_1+\hat{x_2}t
$$
利用上式可求得$s_1$，进而求$s_2$

#### 3D-2D: PnP
**已知空间中一组3D点的位置以及它们在某个相机中的投影位置**

1. **直接线性变换(DLT)**
   考虑空间中一个点，在世界坐标系下其齐次坐标为$P=(X,Y,Z,1)^T$，在图像$I_1$中，投影的特征点为(归一化坐标)$x_1=(u_1,v_1,1)^T$，利用坐标变换(中间为增广矩阵$[R|t]$)可以得到
   $$
   s
   \begin{bmatrix}
   u_1 \\ v_1 \\ 1
   \end{bmatrix} =
   \begin{bmatrix} 
   t_1 & t_2 & t_3 & t_4 \\
   t_5 & t_6 & t_7 & t_8 \\
   t_9 & t_{10} & t_{11} & t_{12} \\
   \end{bmatrix}
   \begin{bmatrix}
   X \\ Y \\ Z \\ 1
   \end{bmatrix} 
   $$
   令增广矩阵三行分别为向量$\bold{t_1},\bold{t_2},\bold{t_3}$，消去深度信息$s$得到
   $$
   \bold{t_1}^T \bold{P}-\bold{t_3}\bold{P}u_1=0 \\
   \bold{t_2}^T \bold{P}-\bold{t_3}\bold{P}v_1=0
   $$
   由于增广矩阵存在12个变量，一个特征点可给出两个独立方程，故有6组特征点时可解出位姿变换$R,t$。特别地，大于6组时方程超定，考虑最小二乘解
2. P3P
   P3P仅使用3对匹配点
   ![](./image/ch7/2024-03-13%2015-48-48%20的屏幕截图.png)
   基本流程:
      由三对匹配点的空间坐标(世界坐标系下坐标)和对应像素坐标求解三对点在相机坐标系下坐标(利用几何关系)，转为求解3D-3D问题，进而求得相机运动R,t

   方法二：最小化重投影误差求解PnP
   即求解最优化问题（$u_i,P_i$为第$i$个点的像素坐标与世界坐标系下坐标）:
   $$
   T^{\star}=\argmin_{T} \frac{1}{2} \sum_{i=1}^n ||u_i-\frac{1}{s_i}KTP_i||_2^2
   $$

#### 3D-3D：ICP
   


## 直接法